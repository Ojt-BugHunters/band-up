name: Frontend CI

on:
    workflow_dispatch:
    push:
        branches: main
    pull_request:
        branches: main

permissions:
    contents: read
    pull-requests: read

jobs:
    frontend-ci:
        name: Frontend CI
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./frontend
        steps:
            - uses: actions/checkout@v4

            - name: Install Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install

            - name: Check TypeScript types
              run: bun run check-types

            - name: Lint
              run: bun run lint
    backend-ci:
        name: Backend CI/CD
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./backend
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Log in to Docker Hub
              uses: docker/login-action@v2
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Build and Push Docker Image
              uses: docker/build-push-action@v4
              with:
                  context: ./backend
                  file: ./backend/Dockerfile
                  push: true
                  tags: hoangworthy/brand_up_backend:latest
            
            - name: Deploy to On-Prem Server
              uses: appleboy/ssh-action@v0.1.7
              with:
                  host: ${{ secrets.SERVER_IP }}
                  username: ${{ secrets.SERVER_USER }}
                  key: ${{ secrets.SERVER_SSH_KEY }}
                  script: |
                      cd /Study/brand_up_backend
                      git pull origin main
                      docker-compose pull
                      docker-compose up -d
          
