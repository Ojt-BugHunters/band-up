<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Enhanced Test Viewer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-btn {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            transition: background 0.3s;
        }

        .back-btn:hover { background: #5568d3; }

        .test-info { text-align: center; flex-grow: 1; }
        .test-info h1 { color: #333; font-size: 22px; margin-bottom: 5px; }
        .test-meta { color: #666; font-size: 13px; }

        .container {
            max-width: 1600px;
            margin: 20px auto;
            display: flex;
            gap: 20px;
            padding: 0 20px;
            height: calc(100vh - 120px);
        }

        .left-panel, .right-panel {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .left-panel { flex: 1; padding: 25px; }
        .right-panel { flex: 0 0 420px; padding: 20px; }

        .panel-header {
            position: sticky;
            top: 0;
            background: white;
            padding-bottom: 15px;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            z-index: 10;
        }

        .panel-header h2 { color: #667eea; font-size: 18px; }

        /* Content styling */
        .content-area { line-height: 1.7; color: #333; }
        .content-area h2, .content-area h3, .content-area h4 { color: #667eea; margin: 15px 0 10px; }
        .content-area p { margin-bottom: 12px; }
        .content-area table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .content-area td, .content-area th { border: 1px solid #ddd; padding: 8px; }
        .content-area img { max-width: 100%; height: auto; margin: 15px 0; border-radius: 5px; }
        .content-area ul, .content-area ol { margin: 12px 0; padding-left: 25px; }
        .content-area li { margin-bottom: 6px; }

        /* Section styling */
        .section-block {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .section-title {
            color: #667eea;
            font-size: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        /* Audio player */
        .audio-player {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .audio-player h4 { color: #667eea; margin-bottom: 10px; font-size: 14px; }
        .audio-player audio { width: 100%; }

        /* Answer section */
        .answer-section { margin-bottom: 25px; }
        .answer-section-title {
            color: #667eea;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            padding: 8px 12px;
            background: #f0f4ff;
            border-radius: 5px;
        }

        .answer-grid { display: flex; flex-direction: column; gap: 10px; }

        .answer-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: #fafafa;
            border-radius: 5px;
            transition: background 0.2s;
        }

        .answer-item:hover { background: #f0f4ff; }

        .answer-item label {
            font-weight: 600;
            color: #555;
            min-width: 30px;
            font-size: 13px;
        }

        /* Question type specific inputs */
        .input-text {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-text:focus { outline: none; border-color: #667eea; }

        /* Multiple choice */
        .mc-options { display: flex; gap: 8px; flex: 1; }
        .mc-option {
            padding: 8px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            background: white;
        }

        .mc-option:hover { border-color: #667eea; background: #f0f4ff; }
        .mc-option.selected { background: #667eea; color: white; border-color: #667eea; }
        .mc-option.multi.selected { background: #5c6bc0; }

        /* True/False/Not Given */
        .tf-options { display: flex; gap: 6px; flex: 1; flex-wrap: wrap; }
        .tf-option {
            padding: 6px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
            background: white;
        }

        .tf-option:hover { border-color: #28a745; background: #e8f5e9; }
        .tf-option.selected { background: #28a745; color: white; border-color: #28a745; }

        /* Matching heading */
        .mh-select {
            flex: 1;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
        }

        .mh-select:focus { outline: none; border-color: #667eea; }

        /* Show answers button */
        .show-answers-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            background: #667eea;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            z-index: 1000;
        }

        .show-answers-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .show-answers-btn.active { background: #28a745; }

        /* Answers display */
        .answers-display {
            display: none;
            background: #f0fff4;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border: 2px solid #28a745;
        }

        .answers-display.show { display: block; }
        .answers-display h3 { color: #28a745; margin-bottom: 12px; font-size: 16px; }

        .answer-key-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .answer-key-item {
            background: white;
            padding: 8px 12px;
            border-radius: 5px;
            border-left: 3px solid #28a745;
            font-size: 13px;
        }

        .answer-key-item strong { color: #667eea; }

        /* Scrollbar */
        .left-panel::-webkit-scrollbar, .right-panel::-webkit-scrollbar { width: 8px; }
        .left-panel::-webkit-scrollbar-track, .right-panel::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .left-panel::-webkit-scrollbar-thumb, .right-panel::-webkit-scrollbar-thumb { background: #667eea; border-radius: 10px; }

        /* Hide ads */
        .ielts-manual-ads, .et_pb_code, .adsbygoogle, .ielts-adlabel,
        [class*="ad-"], [class*="ads-"], .orp-player-wrapper { display: none !important; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <a href="/" class="back-btn">‚Üê Back</a>
            <div class="test-info">
                <h1 id="test-title">Loading...</h1>
                <div class="test-meta">
                    <span id="test-type"></span> | <span id="test-number"></span> | <span id="total-questions"></span>
                </div>
            </div>
            <div style="width: 80px;"></div>
        </div>
    </div>

    <div class="container">
        <div class="left-panel">
            <div class="panel-header">
                <h2 id="left-header">üìÑ Test Content</h2>
            </div>
            <div id="content-area" class="content-area"></div>
        </div>

        <div class="right-panel">
            <div class="panel-header">
                <h2>‚úèÔ∏è Your Answers</h2>
            </div>
            <div id="answer-area"></div>
            <div id="answers-display" class="answers-display"></div>
        </div>
    </div>

    <button class="show-answers-btn" onclick="toggleAnswers()">
        <span id="btn-text">üëÅÔ∏è Show Answers</span>
    </button>

    <script>
        const skill = "{{ skill }}";
        const testType = "{{ test_type }}";
        const filename = "{{ filename }}";
        let testData = null;
        let questionTypes = {};
        let answersVisible = false;

        // Load test data
        fetch(`/api/test/${skill}/${testType}/${filename}`)
            .then(response => response.json())
            .then(data => {
                testData = data;
                parseQuestionTypes(data);
                renderTest(data);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('content-area').innerHTML = `<p style="color:red;">Error loading test</p>`;
            });

        function parseQuestionTypes(data) {
            // Parse questionTypes array into a map
            if (data.questionTypes && Array.isArray(data.questionTypes)) {
                data.questionTypes.forEach(qt => {
                    const key = Object.keys(qt)[0];
                    const num = parseInt(key.replace('Question_', ''));
                    questionTypes[num] = qt[key];
                });
            }
        }

        function getQuestionType(num) {
            return questionTypes[num] || 'SA'; // Default to short answer
        }

        function renderTest(data) {
            const testName = data.test_metadata?.test_name || data.testName || 'IELTS Test';
            const testTypeStr = data.test_metadata?.test_type || data.testType || 'practice';
            const testNum = data.test_metadata?.test_number || data.testNumber || 'N/A';
            
            document.getElementById('test-title').textContent = testName;
            document.getElementById('test-type').textContent = `Type: ${testTypeStr}`;
            document.getElementById('test-number').textContent = `Test #${testNum}`;
            document.getElementById('total-questions').textContent = `40 Questions`;

            if (skill === 'reading') {
                document.getElementById('left-header').textContent = 'üìñ Reading Passages';
                renderReadingTest(data);
            } else if (skill === 'listening') {
                document.getElementById('left-header').textContent = 'üéß Listening Sections';
                renderListeningTest(data);
            }
        }

        function cleanHtml(html) {
            // Remove ad-related content
            const div = document.createElement('div');
            div.innerHTML = html;
            
            const adSelectors = [
                '.ielts-manual-ads', '.et_pb_code', '.adsbygoogle', '.ielts-adlabel',
                '[class*="orp-"]', '[class*="ad.plus"]', 'script', 'ins'
            ];
            
            adSelectors.forEach(sel => {
                div.querySelectorAll(sel).forEach(el => el.remove());
            });
            
            return div.innerHTML;
        }

        function renderReadingTest(data) {
            const contentArea = document.getElementById('content-area');
            let html = '';

            if (data.passages) {
                data.passages.forEach((passage, idx) => {
                    const title = passage.title || `Passage ${idx + 1}`;
                    const content = cleanHtml(passage.content || '');
                    
                    html += `
                        <div class="section-block">
                            <h2 class="section-title">Passage ${idx + 1}: ${title}</h2>
                            <div class="content-area">${content}</div>
                        </div>
                    `;
                });
            }

            contentArea.innerHTML = html;
            renderAnswerInputs();
        }

        function renderListeningTest(data) {
            const contentArea = document.getElementById('content-area');
            let html = '';

            if (data.sections && data.questions) {
                data.sections.forEach((section, idx) => {
                    const sectionQuestions = data.questions.filter(q => q.section_number === section.section_number);
                    const range = section.question_range || [1, 10];
                    
                    html += `
                        <div class="section-block">
                            <h2 class="section-title">${section.title} (Questions ${range[0]}-${range[1]})</h2>
                            <div class="audio-player">
                                <h4>üîä Audio Player</h4>
                                <audio controls>
                                    <source src="/media/${section.audio_file_path}" type="audio/mpeg">
                                    Your browser does not support audio.
                                </audio>
                            </div>
                            ${sectionQuestions.map(q => `<div class="content-area">${cleanHtml(q.html_content || '')}</div>`).join('')}
                        </div>
                    `;
                });
            }

            contentArea.innerHTML = html;
            renderAnswerInputs();
        }

        function renderAnswerInputs() {
            const answerArea = document.getElementById('answer-area');
            let html = '';
            
            // Define passage/section ranges
            let ranges = [];
            if (skill === 'reading') {
                // Reading: 3 passages, typically Q1-13, Q14-26, Q27-40
                ranges = [
                    { name: 'Passage 1', start: 1, end: 13 },
                    { name: 'Passage 2', start: 14, end: 26 },
                    { name: 'Passage 3', start: 27, end: 40 }
                ];
            } else {
                // Listening: 4 sections, Q1-10, Q11-20, Q21-30, Q31-40
                ranges = [
                    { name: 'Section 1', start: 1, end: 10 },
                    { name: 'Section 2', start: 11, end: 20 },
                    { name: 'Section 3', start: 21, end: 30 },
                    { name: 'Section 4', start: 31, end: 40 }
                ];
            }
            
            // Render each passage/section
            ranges.forEach(range => {
                html += `<div class="passage-section" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 16px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">
                        üìë ${range.name} (Q${range.start}-${range.end})
                    </h3>`;
                
                // Group questions by type within this passage/section
                let currentType = '';
                for (let i = range.start; i <= range.end; i++) {
                    const type = getQuestionType(i);
                    
                    if (type !== currentType) {
                        if (currentType !== '') {
                            html += '</div></div>';
                        }
                        currentType = type;
                        html += `<div class="answer-section">
                            <div class="answer-section-title">${getTypeLabel(type)}</div>
                            <div class="answer-grid">`;
                    }
                    
                    html += renderAnswerInput(i, type);
                }
                
                if (currentType !== '') {
                    html += '</div></div>';
                }
                html += '</div>';
            });
            
            answerArea.innerHTML = html;
        }

        function getTypeLabel(type) {
            const labels = {
                // Common types
                'MC': 'üîò Multiple Choice',
                'SA': '‚úçÔ∏è Short Answer',
                'LS': '‚òëÔ∏è List Selection',
                // Reading types
                'TF': '‚úì‚úó True/False/Not Given',
                'MH': 'üîó Matching Headings (i-x)',
                'MI': 'üìÑ Matching Information (A-G)',
                'MF': 'üë§ Matching Features',
                'SC': 'üìù Summary Completion',
                'DN': 'üìä Diagram/Note/Table',
                // Listening types
                'TB': 'üìã Table/Form Completion',
                'MT': 'üîÄ Matching',
                'MP': 'üó∫Ô∏è Map/Plan Labeling'
            };
            return labels[type] || '‚úçÔ∏è Answer';
        }

        function renderAnswerInput(num, type) {
            let input = '';
            
            switch(type) {
                case 'MC': // Multiple Choice A-D
                    input = `
                        <div class="mc-options">
                            <span class="mc-option" onclick="selectOption(this, ${num})">A</span>
                            <span class="mc-option" onclick="selectOption(this, ${num})">B</span>
                            <span class="mc-option" onclick="selectOption(this, ${num})">C</span>
                            <span class="mc-option" onclick="selectOption(this, ${num})">D</span>
                        </div>
                        <input type="hidden" id="answer-${num}" value="">
                    `;
                    break;
                    
                case 'TF': // True/False/Not Given (Reading)
                    input = `
                        <div class="tf-options">
                            <span class="tf-option" onclick="selectOption(this, ${num})">TRUE</span>
                            <span class="tf-option" onclick="selectOption(this, ${num})">FALSE</span>
                            <span class="tf-option" onclick="selectOption(this, ${num})">NOT GIVEN</span>
                        </div>
                        <input type="hidden" id="answer-${num}" value="">
                    `;
                    break;
                    
                case 'MH': // Matching Headings - roman numerals (Reading)
                    input = `
                        <select class="mh-select" id="answer-${num}">
                            <option value="">Select heading...</option>
                            ${['i','ii','iii','iv','v','vi','vii','viii','ix','x','xi','xii'].map(h => 
                                `<option value="${h}">${h}</option>`
                            ).join('')}
                        </select>
                    `;
                    break;
                    
                case 'MI': // Matching Information - paragraph letters A-G (Reading)
                    input = `
                        <div class="mc-options">
                            ${['A','B','C','D','E','F','G'].map(l => 
                                `<span class="mc-option" onclick="selectOption(this, ${num})">${l}</span>`
                            ).join('')}
                        </div>
                        <input type="hidden" id="answer-${num}" value="">
                    `;
                    break;
                    
                case 'MF': // Matching Features A-E (Reading)
                case 'MT': // Matching A-E (Listening)
                    input = `
                        <div class="mc-options">
                            ${['A','B','C','D','E'].map(l => 
                                `<span class="mc-option" onclick="selectOption(this, ${num})">${l}</span>`
                            ).join('')}
                        </div>
                        <input type="hidden" id="answer-${num}" value="">
                    `;
                    break;
                    
                case 'MP': // Map/Plan Labeling A-H (Listening)
                    input = `
                        <div class="mc-options">
                            ${['A','B','C','D','E','F','G','H'].map(l => 
                                `<span class="mc-option" onclick="selectOption(this, ${num})">${l}</span>`
                            ).join('')}
                        </div>
                        <input type="hidden" id="answer-${num}" value="">
                    `;
                    break;
                    
                case 'LS': // List Selection - multiple choice
                    input = `
                        <div class="mc-options" style="flex-wrap: wrap;">
                            ${['A','B','C','D','E','F','G'].map(l => 
                                `<span class="mc-option multi" onclick="toggleMulti(this, ${num})">${l}</span>`
                            ).join('')}
                        </div>
                        <input type="hidden" id="answer-${num}" value="">
                    `;
                    break;
                    
                default: // SA, SC, DN, TB - text input
                    input = `<input type="text" class="input-text" id="answer-${num}" placeholder="Your answer">`;
            }
            
            return `
                <div class="answer-item">
                    <label>${num}.</label>
                    ${input}
                </div>
            `;
        }

        function selectOption(el, num) {
            // Single selection - deselect others first
            el.parentElement.querySelectorAll('.mc-option, .tf-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById(`answer-${num}`).value = el.textContent;
        }

        function toggleMulti(el, num) {
            // Multiple selection for LS type
            el.classList.toggle('selected');
            const selected = Array.from(el.parentElement.querySelectorAll('.selected'))
                .map(opt => opt.textContent)
                .sort()
                .join(', ');
            document.getElementById(`answer-${num}`).value = selected;
        }

        function toggleAnswers() {
            answersVisible = !answersVisible;
            const display = document.getElementById('answers-display');
            const btn = document.querySelector('.show-answers-btn');
            const btnText = document.getElementById('btn-text');

            if (answersVisible) {
                display.classList.add('show');
                btn.classList.add('active');
                btnText.textContent = 'üôà Hide Answers';
                renderAnswers();
            } else {
                display.classList.remove('show');
                btn.classList.remove('active');
                btnText.textContent = 'üëÅÔ∏è Show Answers';
            }
        }

        function renderAnswers() {
            const display = document.getElementById('answers-display');
            
            if (!testData || !testData.answers) {
                display.innerHTML = '<p>No answers available</p>';
                return;
            }

            let html = '<h3>‚úÖ Answer Key</h3><div class="answer-key-grid">';
            
            if (Array.isArray(testData.answers)) {
                testData.answers.forEach(ans => {
                    const num = ans.question_number;
                    const text = ans.answer_text || ans.answer || ans.correct_answer || 'N/A';
                    html += `<div class="answer-key-item"><strong>${num}.</strong> ${text}</div>`;
                });
            }
            
            html += '</div>';
            display.innerHTML = html;
        }
    </script>
</body>
</html>
