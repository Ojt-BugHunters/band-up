<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Speaking Test Viewer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-btn {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            transition: background 0.3s;
        }

        .back-btn:hover { background: #5568d3; }

        .test-info { text-align: center; flex-grow: 1; }
        .test-info h1 { color: #333; font-size: 22px; margin-bottom: 5px; }
        .test-meta { color: #666; font-size: 13px; }

        .part-tabs {
            display: flex;
            gap: 10px;
        }

        .part-tab {
            padding: 10px 20px;
            border: 2px solid #667eea;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            background: white;
            color: #667eea;
        }

        .part-tab:hover { background: #f0f4ff; }
        .part-tab.active { background: #667eea; color: white; }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .main-panel {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 30px;
        }

        .part-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }

        .part-title { color: #667eea; font-size: 24px; }
        .part-topic { color: #555; font-size: 16px; margin-top: 5px; }

        .timer {
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 20px;
            font-weight: bold;
        }

        .timer.warning { background: #e74c3c; }

        /* Question card */
        .question-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .question-text {
            font-size: 18px;
            color: #333;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        /* Cue card for Part 2 */
        .cue-card {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .cue-card h3 { color: #856404; margin-bottom: 15px; }
        .cue-card .topic { font-size: 18px; font-weight: 600; margin-bottom: 15px; }
        .cue-card ul { padding-left: 25px; }
        .cue-card li { margin-bottom: 8px; color: #333; }

        /* Sample answer section */
        .sample-answer {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            display: none;
        }

        .sample-answer.show { display: block; }
        .sample-answer h4 { color: #155724; margin-bottom: 10px; }
        .sample-answer p { color: #333; line-height: 1.7; }

        /* Toggle button */
        .toggle-answer-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .toggle-answer-btn:hover { background: #218838; }
        .toggle-answer-btn.active { background: #dc3545; }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }

        .action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .action-btn.primary { background: #667eea; color: white; }
        .action-btn.primary:hover { background: #5568d3; }
        .action-btn.secondary { background: #f8f9fa; color: #333; border: 2px solid #e0e0e0; }
        .action-btn.secondary:hover { background: #e9ecef; }
        .action-btn.success { background: #28a745; color: white; }
        .action-btn.success:hover { background: #218838; }

        /* Part info */
        .part-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .part-info p { color: #1565c0; margin: 5px 0; font-size: 14px; }

        /* Hide ads */
        .ielts-manual-ads, .et_pb_code, .adsbygoogle { display: none !important; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <a href="/" class="back-btn">‚Üê Back</a>
            <div class="test-info">
                <h1 id="test-title">Loading...</h1>
                <div class="test-meta">
                    <span id="test-type"></span> | <span id="test-number"></span>
                </div>
            </div>
            <div class="part-tabs">
                <div class="part-tab active" onclick="switchPart(1)">Part 1</div>
                <div class="part-tab" onclick="switchPart(2)">Part 2</div>
                <div class="part-tab" onclick="switchPart(3)">Part 3</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="main-panel">
            <div class="part-header">
                <div>
                    <h2 class="part-title" id="part-title">Part 1</h2>
                    <div class="part-topic" id="part-topic"></div>
                </div>
                <div class="timer" id="timer">00:00</div>
            </div>

            <div id="part-info" class="part-info"></div>
            <div id="questions-area"></div>

            <div class="action-buttons">
                <button class="action-btn primary" onclick="startTimer()">‚è±Ô∏è Start Timer</button>
                <button class="action-btn secondary" onclick="resetTimer()">üîÑ Reset</button>
                <button class="action-btn success" onclick="toggleAllAnswers()">
                    <span id="toggle-all-text">üëÅÔ∏è Show All Answers</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        const skill = "{{ skill }}";
        const testType = "{{ test_type }}";
        const filename = "{{ filename }}";
        let testData = null;
        let currentPart = 1;
        let timerInterval = null;
        let seconds = 0;
        let timerRunning = false;
        let allAnswersVisible = false;

        // Load test data
        fetch(`/api/test/${skill}/${testType}/${filename}`)
            .then(response => response.json())
            .then(data => {
                testData = data;
                renderTest(data);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('questions-area').innerHTML = `<p style="color:red;">Error loading test</p>`;
            });

        function renderTest(data) {
            const testName = data.test_metadata?.test_name || 'Speaking Test';
            const testTypeStr = data.test_metadata?.test_type || 'practice';
            const testNum = data.test_metadata?.test_number || 'N/A';
            
            document.getElementById('test-title').textContent = testName;
            document.getElementById('test-type').textContent = `Type: ${testTypeStr}`;
            document.getElementById('test-number').textContent = `Test #${testNum}`;

            renderPart(currentPart);
        }

        function switchPart(partNum) {
            currentPart = partNum;
            
            document.querySelectorAll('.part-tab').forEach((tab, idx) => {
                tab.classList.toggle('active', idx + 1 === partNum);
            });
            
            // Reset timer when switching parts
            resetTimer();
            allAnswersVisible = false;
            document.getElementById('toggle-all-text').textContent = 'üëÅÔ∏è Show All Answers';
            
            renderPart(partNum);
        }

        function renderPart(partNum) {
            if (!testData || !testData.parts) return;
            
            const part = testData.parts[partNum - 1];
            if (!part) return;

            document.getElementById('part-title').textContent = part.title || `Part ${partNum}`;
            document.getElementById('part-topic').textContent = part.topic || '';

            // Part info
            const infoBox = document.getElementById('part-info');
            if (partNum === 1) {
                infoBox.innerHTML = `
                    <p>‚è±Ô∏è <strong>Time:</strong> 4-5 minutes</p>
                    <p>üìã <strong>Format:</strong> Introduction and general questions about familiar topics</p>
                `;
            } else if (partNum === 2) {
                infoBox.innerHTML = `
                    <p>‚è±Ô∏è <strong>Time:</strong> 3-4 minutes (1 min preparation + 2 min speaking)</p>
                    <p>üìã <strong>Format:</strong> Individual long turn - speak about a topic using the cue card</p>
                `;
            } else {
                infoBox.innerHTML = `
                    <p>‚è±Ô∏è <strong>Time:</strong> 4-5 minutes</p>
                    <p>üìã <strong>Format:</strong> Two-way discussion - more abstract questions related to Part 2 topic</p>
                `;
            }

            // Render questions
            const questionsArea = document.getElementById('questions-area');
            let html = '';

            if (part.questions && part.questions.length > 0) {
                part.questions.forEach((q, idx) => {
                    if (partNum === 2 && q.cue_points) {
                        // Cue card format for Part 2
                        html += `
                            <div class="cue-card">
                                <h3>üìù Cue Card</h3>
                                <div class="topic">${q.question || part.topic}</div>
                                <p>You should say:</p>
                                <ul>
                                    ${q.cue_points.map(point => `<li>${point}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                        if (part.sample_answer) {
                            html += `
                                <div class="question-card">
                                    <button class="toggle-answer-btn" onclick="toggleAnswer(this, 'answer-${idx}')">
                                        üëÅÔ∏è Show Sample Answer
                                    </button>
                                    <div class="sample-answer" id="answer-${idx}">
                                        <h4>‚úÖ Sample Answer</h4>
                                        <p>${part.sample_answer}</p>
                                    </div>
                                </div>
                            `;
                        }
                    } else {
                        // Regular Q&A format
                        html += `
                            <div class="question-card">
                                <div class="question-text">‚ùì ${q.question}</div>
                                <button class="toggle-answer-btn" onclick="toggleAnswer(this, 'answer-${idx}')">
                                    üëÅÔ∏è Show Sample Answer
                                </button>
                                <div class="sample-answer" id="answer-${idx}">
                                    <h4>‚úÖ Sample Answer</h4>
                                    <p>${q.sample_answer || 'No sample answer available'}</p>
                                </div>
                            </div>
                        `;
                    }
                });
            } else {
                html = '<p>No questions available for this part.</p>';
            }

            questionsArea.innerHTML = html;
        }

        function toggleAnswer(btn, answerId) {
            const answerDiv = document.getElementById(answerId);
            answerDiv.classList.toggle('show');
            
            if (answerDiv.classList.contains('show')) {
                btn.textContent = 'üôà Hide Sample Answer';
                btn.classList.add('active');
            } else {
                btn.textContent = 'üëÅÔ∏è Show Sample Answer';
                btn.classList.remove('active');
            }
        }

        function toggleAllAnswers() {
            allAnswersVisible = !allAnswersVisible;
            const answers = document.querySelectorAll('.sample-answer');
            const buttons = document.querySelectorAll('.toggle-answer-btn');
            
            answers.forEach(ans => {
                ans.classList.toggle('show', allAnswersVisible);
            });
            
            buttons.forEach(btn => {
                btn.textContent = allAnswersVisible ? 'üôà Hide Sample Answer' : 'üëÅÔ∏è Show Sample Answer';
                btn.classList.toggle('active', allAnswersVisible);
            });
            
            document.getElementById('toggle-all-text').textContent = 
                allAnswersVisible ? 'üôà Hide All Answers' : 'üëÅÔ∏è Show All Answers';
        }

        // Timer functions
        function startTimer() {
            if (timerRunning) {
                clearInterval(timerInterval);
                timerRunning = false;
                document.querySelector('.action-btn.primary').textContent = '‚ñ∂Ô∏è Resume';
            } else {
                timerRunning = true;
                document.querySelector('.action-btn.primary').textContent = '‚è∏Ô∏è Pause';
                timerInterval = setInterval(() => {
                    seconds++;
                    updateTimerDisplay();
                }, 1000);
            }
        }

        function resetTimer() {
            clearInterval(timerInterval);
            seconds = 0;
            timerRunning = false;
            updateTimerDisplay();
            document.querySelector('.action-btn.primary').textContent = '‚è±Ô∏è Start Timer';
            document.getElementById('timer').classList.remove('warning');
        }

        function updateTimerDisplay() {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            const display = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            const timerEl = document.getElementById('timer');
            timerEl.textContent = display;
            
            // Warning based on part
            const limits = { 1: 5, 2: 4, 3: 5 };
            if (mins >= limits[currentPart]) {
                timerEl.classList.add('warning');
            }
        }
    </script>
</body>
</html>
